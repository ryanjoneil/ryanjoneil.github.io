<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>üî≤ Magic Squares and Big-Ms | adventures in optimization</title>
<meta name="keywords" content="integer programming, modeling, scip, python">
<meta name="description" content="An integer programming formulation of the magic squares problem.">
<meta name="author" content="Ryan O&#39;Neil">
<link rel="canonical" href="https://ryanjoneil.github.io/posts/2012-01-12-magic-squares-and-big-ms/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7c3f0ab5ecc8326dc20e6644afa4081b33304fef3299b2c1179eaee195843a6a.css" integrity="sha256-fD8KtezIMm3CDmZEr6QIGzMwT&#43;8ymbLBF56u4ZWEOmo=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://ryanjoneil.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ryanjoneil.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ryanjoneil.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ryanjoneil.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://ryanjoneil.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
    integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn"
    crossorigin="anonymous"/>
<script
    src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"
    integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx"
    crossorigin="anonymous">
</script>

<script
    src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
    crossorigin="anonymous"
    onload="renderMathInElement(document.body);">
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>

<meta property="og:title" content="üî≤ Magic Squares and Big-Ms" />
<meta property="og:description" content="An integer programming formulation of the magic squares problem." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ryanjoneil.github.io/posts/2012-01-12-magic-squares-and-big-ms/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-01-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2012-01-12T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="üî≤ Magic Squares and Big-Ms"/>
<meta name="twitter:description" content="An integer programming formulation of the magic squares problem."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://ryanjoneil.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "üî≤ Magic Squares and Big-Ms",
      "item": "https://ryanjoneil.github.io/posts/2012-01-12-magic-squares-and-big-ms/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "üî≤ Magic Squares and Big-Ms",
  "name": "üî≤ Magic Squares and Big-Ms",
  "description": "An integer programming formulation of the magic squares problem.",
  "keywords": [
    "integer programming", "modeling", "scip", "python"
  ],
  "articleBody": "Note: This post was updated to work with Python 3 and PySCIPOpt. The original version used Python 2 and python-zibopt. It has also been edited for clarity.\nBack in October of 2011, I started toying with a model for finding magic squares using SCIP. This is a fun modeling exercise and a challenging problem. First one constructs a square matrix of integer-valued variables.\nfrom pyscipopt import Model # [...snip...] m = Model() matrix = [] for i in range(size): row = [m.addVar(vtype=\"I\", lb=1) for _ in range(size)] for x in row: m.addCons(x \u003c= M) matrix.append(row) Then one adds the following constraints:\nAll variables ‚â• 1. All rows, columns, and the diagonal sum to the same value. All variables take different values. The first two constraints are trivial to implement, and relatively easy for the solver. What I do is add a single extra variable then set it equal to the sums of each row, column, and the diagonal.\nsum_val = m.addVar(vtype=\"M\") for i in range(size): m.addCons(sum(matrix[i]) == sum_val) m.addCons(sum(matrix[j][i] for j in range(size)) == sum_val) m.addCons(sum(matrix[i][i] for i in range(size)) == sum_val) It‚Äôs the third that messes things up. You can think of this as saying, for every possible pair of integer-valued variables $x$ and $y$:\n$$ x \\ge y + 1 \\quad \\text{or} \\quad x \\le y - 1 $$\nWhy is this hard? Because we can‚Äôt add both constraints to the model. That would make it infeasible. Instead, we add write them in such a way that exactly one will be active for any any given solution. This requires, for each pair of variables, an additional binary variable $z$ and a (possibly big) constant $M$. Thus we reformulate the above as:\n$$ x \\ge (y + 1) - M z \\ x \\le (y - 1) + M (1-z) \\ z \\in {0,1} $$\nIn code this looks like:\nfrom itertools import chain all_vars = list(chain(*matrix)) for i, x in enumerate(all_vars): for y in all_vars[i+1:]: z = m.addVar(vtype=\"B\") m.addCons(x \u003e= y + 1 - M*z) m.addCons(x \u003c= y - 1 + M*(1-z)) However, here be dragons. We may not know how big (or small) to make $M$. Generally we want it as small as possible to make the LP relaxation of our integer programming model tighter. Different values of $M$ have unpredictable effects on solution time.\nWhich brings us to an interesting idea:\nSCIP now supports bilinear constraints. This means that I can make $M$ a variable in the above model.\nimport sys try: M = int(sys.argv[2]) except IndexError: M = m.addVar(vtype=\"M\", lb=size * size) else: assert M \u003e= size * size The magic square model linked to in this post provides both options. The first command line argument it requires is the matrix size. The second one, $M$, is optional. If not given, it leaves $M$ up to the solver.\nAn interesting exercise for the reader: Change the code to search for a minimal magic square, which minimizes either the value of $M$ or the sums of the columns, rows, and diagonal.\n",
  "wordCount" : "505",
  "inLanguage": "en",
  "datePublished": "2012-01-12T00:00:00Z",
  "dateModified": "2012-01-12T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Ryan O'Neil"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ryanjoneil.github.io/posts/2012-01-12-magic-squares-and-big-ms/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "adventures in optimization",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ryanjoneil.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ryanjoneil.github.io/" accesskey="h" title="adventures in optimization (Alt + H)">adventures in optimization</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ryanjoneil.github.io/about" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://ryanjoneil.github.io/coding" title="coding">
                    <span>coding</span>
                </a>
            </li>
            <li>
                <a href="https://ryanjoneil.github.io/posts" title="posting">
                    <span>posting</span>
                </a>
            </li>
            <li>
                <a href="https://ryanjoneil.github.io/speaking" title="speaking">
                    <span>speaking</span>
                </a>
            </li>
            <li>
                <a href="https://ryanjoneil.github.io/writing" title="writing">
                    <span>writing</span>
                </a>
            </li>
            <li>
                <a href="https://ryanjoneil.github.io/search" title="üîç">
                    <span>üîç</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      üî≤ Magic Squares and Big-Ms
    </h1>
    <div class="post-description">
      An integer programming formulation of the magic squares problem.
    </div>
    <div class="post-meta"><span title='2012-01-12 00:00:00 +0000 UTC'>January 12, 2012</span>&nbsp;¬∑&nbsp;Ryan O&#39;Neil

</div>
  </header> 

  <div class="post-content"><p><em>Note: This post was updated to work with Python 3 and <a href="https://github.com/scipopt/PySCIPOpt">PySCIPOpt</a>. The original version used Python 2 and <a href="https://pythonhosted.org/python-zibopt/">python-zibopt</a>. It has also been edited for clarity.</em></p>
<p>Back in October of 2011, I started toying with a model for finding <a href="https://en.wikipedia.org/wiki/Magic_square">magic squares</a> using SCIP. This is a fun modeling exercise and a challenging problem. First one constructs a square matrix of integer-valued variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pyscipopt <span style="color:#f92672">import</span> Model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [...snip...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m <span style="color:#f92672">=</span> Model()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>matrix <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(size):
</span></span><span style="display:flex;"><span>    row <span style="color:#f92672">=</span> [m<span style="color:#f92672">.</span>addVar(vtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;I&#34;</span>, lb<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(size)]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> row:
</span></span><span style="display:flex;"><span>        m<span style="color:#f92672">.</span>addCons(x <span style="color:#f92672">&lt;=</span> M)
</span></span><span style="display:flex;"><span>    matrix<span style="color:#f92672">.</span>append(row)
</span></span></code></pre></div><p>Then one adds the following constraints:</p>
<ul>
<li>All variables ‚â• 1.</li>
<li>All rows, columns, and the diagonal sum to the same value.</li>
<li>All variables take different values.</li>
</ul>
<p>The first two constraints are trivial to implement, and relatively easy for the solver. What I do is add a single extra variable then set it equal to the sums of each row, column, and the diagonal.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sum_val <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>addVar(vtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;M&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(size):
</span></span><span style="display:flex;"><span>    m<span style="color:#f92672">.</span>addCons(sum(matrix[i]) <span style="color:#f92672">==</span> sum_val)
</span></span><span style="display:flex;"><span>    m<span style="color:#f92672">.</span>addCons(sum(matrix[j][i] <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(size)) <span style="color:#f92672">==</span> sum_val)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>addCons(sum(matrix[i][i] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(size)) <span style="color:#f92672">==</span> sum_val)
</span></span></code></pre></div><p>It&rsquo;s the third that messes things up. You can think of this as saying, for every possible pair of integer-valued variables $x$ and $y$:</p>
<p>$$ x \ge y + 1 \quad \text{or} \quad x \le y - 1 $$</p>
<p>Why is this hard? Because we can&rsquo;t add both constraints to the model. That would make it infeasible. Instead, we add write them in such a way that exactly one will be active for any any given solution. This requires, for each pair of variables, an additional binary variable $z$ and a (possibly big) constant $M$. Thus we reformulate the above as:</p>
<p>$$
x \ge (y + 1) - M z \
x \le (y - 1) + M (1-z) \
z \in {0,1}
$$</p>
<p>In code this looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> chain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>all_vars <span style="color:#f92672">=</span> list(chain(<span style="color:#f92672">*</span>matrix))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, x <span style="color:#f92672">in</span> enumerate(all_vars):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> all_vars[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]:
</span></span><span style="display:flex;"><span>        z <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>addVar(vtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;B&#34;</span>)
</span></span><span style="display:flex;"><span>        m<span style="color:#f92672">.</span>addCons(x <span style="color:#f92672">&gt;=</span> y <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> M<span style="color:#f92672">*</span>z)
</span></span><span style="display:flex;"><span>        m<span style="color:#f92672">.</span>addCons(x <span style="color:#f92672">&lt;=</span> y <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> M<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>z))
</span></span></code></pre></div><p>However, <a href="https://orinanobworld.blogspot.com/2011/07/perils-of-big-m.html">here be dragons</a>. We may not know how big (or small) to make $M$. Generally we want it as small as possible to make the LP relaxation of our integer programming model tighter. Different values of $M$ have unpredictable effects on solution time.</p>
<p>Which brings us to an interesting idea:</p>
<p>SCIP now supports bilinear constraints. This means that I can make $M$ a variable in the above model.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    M <span style="color:#f92672">=</span> int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IndexError</span>:
</span></span><span style="display:flex;"><span>    M <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>addVar(vtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;M&#34;</span>, lb<span style="color:#f92672">=</span>size <span style="color:#f92672">*</span> size)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> M <span style="color:#f92672">&gt;=</span> size <span style="color:#f92672">*</span> size
</span></span></code></pre></div><p>The magic square model linked to in this post provides both options. The first command line argument it requires is the matrix size. The second one, $M$, is optional. If not given, it leaves $M$ up to the solver.</p>
<p>An interesting exercise for the reader: Change <a href="/files/2012-01-12-magic-squares-and-big-ms/magic-square.py">the code</a> to search for a <em>minimal</em> magic square, which minimizes either the value of $M$ or the sums of the columns, rows, and diagonal.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://ryanjoneil.github.io/tags/integer-programming/">integer programming</a></li>
      <li><a href="https://ryanjoneil.github.io/tags/modeling/">modeling</a></li>
      <li><a href="https://ryanjoneil.github.io/tags/scip/">scip</a></li>
      <li><a href="https://ryanjoneil.github.io/tags/python/">python</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://ryanjoneil.github.io/posts/2023-09-07-blogging-is-back/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>üöÄ Blogging is back, baby!</span>
  </a>
  <a class="next" href="https://ryanjoneil.github.io/posts/2011-11-25-know-your-time-complexities-part-2/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>‚è≥Ô∏è Know Your Time Complexities - Part 2</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://ryanjoneil.github.io/">adventures in optimization</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
